name: Update DNS filter

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare directories
        run: |
          mkdir -p block_hosts/logs
          mkdir -p block_hosts/recent

      - name: Backup old domains
        run: |
          if [ -f block_hosts/filter.html ]; then
            grep -v '^!' block_hosts/filter.html | sort -u > block_hosts/recent/old.txt
          else
            touch block_hosts/recent/old.txt
          fi

      - name: Download hosts
        run: |
          curl -L https://raw.githubusercontent.com/ImMALWARE/dns.malw.link/master/hosts \
          -o block_hosts/recent/hosts.txt

      - name: Extract domains
        run: |
          awk '/# Блокировка/{flag=1;next}/# dns.malw.link: end hosts file/{flag=0}flag && $1=="0.0.0.0"{print "||"$2"^"}' \
          block_hosts/recent/hosts.txt | sort -u \
          > block_hosts/recent/new.txt

      - name: Write log
        run: |
          DATE=$(date -u +"%Y-%m-%d_%H-%M-%S")
          LOG=block_hosts/logs/$DATE.log

          OLD=block_hosts/recent/old.txt
          NEW=block_hosts/recent/new.txt

          echo "Update: $DATE" > "$LOG"
          echo "" >> "$LOG"

          echo "Added:" >> "$LOG"
          comm -13 "$OLD" "$NEW" | sed 's/^/+ /' >> "$LOG"

          echo "" >> "$LOG"
          echo "Removed:" >> "$LOG"
          comm -23 "$OLD" "$NEW" | sed 's/^/- /' >> "$LOG"

      - name: Preserve header
        run: |
          HEADER=block_hosts/recent/header.txt

          if [ -f block_hosts/filter.html ]; then
            grep '^!' block_hosts/filter.html > "$HEADER"
          else
            echo "! Title: DNS Filter" > "$HEADER"
          fi

          DATE_ISO=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")

          if grep -q "Last modified:" "$HEADER"; then
            sed -i "s|Last modified:.*|Last modified: $DATE_ISO|" "$HEADER"
          else
            echo "! Last modified: $DATE_ISO" >> "$HEADER"
          fi

      - name: Rebuild filter
        run: |
          cat block_hosts/recent/header.txt block_hosts/recent/new.txt > block_hosts/filter.html

      - name: Commit
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

          git add block_hosts/filter.html
          git add block_hosts/logs
          git add block_hosts/recent

          if git diff --cached --quiet; then
            echo "No changes"
          else
            git commit -m "Auto update DNS filter"
            git push
          fi
