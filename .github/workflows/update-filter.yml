name: Update DNS filter

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create dirs
        run: |
          mkdir -p "block hosts file/logs"

      - name: Backup old domains
        run: |
          if [ -f "block hosts file/filter.html" ]; then
            grep -v '^!' "block hosts file/filter.html" | sort -u > old.txt
          else
            touch old.txt
          fi

      - name: Download hosts
        run: |
          curl -L https://raw.githubusercontent.com/ImMALWARE/dns.malw.link/master/hosts -o hosts.txt

      - name: Extract domains
        run: |
          awk '/# Блокировка/{flag=1;next}/# dns.malw.link: end hosts file/{flag=0}flag && $1=="0.0.0.0"{print "||"$2"^"}' hosts.txt | sort -u > new.txt

      - name: Write log
        run: |
          DATE=$(date -u +"%Y-%m-%d_%H-%M-%S")
          LOG="block hosts file/logs/$DATE.log"

          echo "Update: $DATE" > "$LOG"
          echo "" >> "$LOG"

          echo "Added:" >> "$LOG"
          comm -13 old.txt new.txt | sed 's/^/+ /' >> "$LOG"

          echo "" >> "$LOG"
          echo "Removed:" >> "$LOG"
          comm -23 old.txt new.txt | sed 's/^/- /' >> "$LOG"

      - name: Preserve header
        run: |
          if [ -f "block hosts file/filter.html" ]; then
            grep '^!' "block hosts file/filter.html" > header.txt
          else
            echo "! Title: DNS Filter" > header.txt
          fi

          DATE_ISO=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")

          if grep -q "Last modified:" header.txt; then
            sed -i "s|Last modified:.*|Last modified: $DATE_ISO|" header.txt
          else
            echo "! Last modified: $DATE_ISO" >> header.txt
          fi

      - name: Rebuild filter
        run: |
          cat header.txt new.txt > "block hosts file/filter.html"

      - name: Commit
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add .

          if git diff --cached --quiet; then
            echo "No changes"
          else
            git commit -m "Auto update DNS filter"
            git push
          fi
