name: Update DNS filter (overwrite + logs)

on:
  schedule:
    - cron: '0 3 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-filter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare paths
        run: |
          FILTER_DIR="block hosts file"
          LOG_DIR="$FILTER_DIR/logs"

          mkdir -p "$LOG_DIR"

          echo "FILTER=$FILTER_DIR/filter.html" >> $GITHUB_ENV
          echo "LOG_DIR=$LOG_DIR" >> $GITHUB_ENV

      - name: Backup old domains
        run: |
          grep -v '^!' "$FILTER" | sort -u > old_domains.txt || true

      - name: Download hosts file
        run: |
          curl -L https://raw.githubusercontent.com/ImMALWARE/dns.malw.link/master/hosts -o hosts.txt

      - name: Extract and convert domains
        run: |
          awk '
          /# Блокировка/ {flag=1; next}
          /# dns.malw.link: end hosts file/ {flag=0}
          flag && $1 == "0.0.0.0" {print "||"$2"^"}
          ' hosts.txt | sort -u > new_domains.txt

      - name: Generate diff log
        run: |
          DATE=$(date -u +"%Y-%m-%d_%H-%M-%S")
          LOG_FILE="$LOG_DIR/$DATE.log"

          touch old_domains.txt new_domains.txt

          echo "Update date: $DATE" > "$LOG_FILE"
          echo "" >> "$LOG_FILE"

          echo "Added domains:" >> "$LOG_FILE"
          comm -13 old_domains.txt new_domains.txt | sed 's/^/+ /' >> "$LOG_FILE"

          echo "" >> "$LOG_FILE"
          echo "Removed domains:" >> "$LOG_FILE"
          comm -23 old_domains.txt new_domains.txt | sed 's/^/- /' >> "$LOG_FILE"

          echo "LOG_FILE=$LOG_FILE" >> $GITHUB_ENV

      - name: Preserve and update header
        run: |
          grep '^!' "$FILTER" > header.txt || true

          DATE_ISO=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")

          if grep -q "Last modified:" header.txt; then
            sed -i "s|Last modified:.*|Last modified: $DATE_ISO|" header.txt
          else
            echo "! Last modified: $DATE_ISO" >> header.txt
          fi

      - name: Rebuild filter file
        run: |
          cat header.txt new_domains.txt > "$FILTER"

      - name: Commit changes and logs
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add "$FILTER"
          git add "$LOG_DIR"

          if git diff --cached --quiet; then
            echo "No changes"
          else
            git commit -m "Auto update DNS filter

Added: $(comm -13 old_domains.txt new_domains.txt | wc -l)
Removed: $(comm -23 old_domains.txt new_domains.txt | wc -l)"
            git push
          fi
